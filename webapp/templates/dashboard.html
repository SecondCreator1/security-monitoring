<!DOCTYPE html>
<html lang="en">
<head>
    <title>Security Logs Dashboard</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1 class="mb-0 text-center flex-grow-1">Security Dashboard</h1>
        <a href="/alertspage" class="btn btn-sm btn-outline-danger ms-3">
            View Alerts
        </a>
    </div>

    <!-- KPIs section -->
    <div class="row text-center mb-4" id="kpi-section">
        <div class="col">
            <div class="card p-3 mb-3 shadow">
                <h5>Total Logs</h5>
                <h2 id="kpi-total">...</h2>
            </div>
        </div>
        <div class="col">
            <div class="card p-3 mb-3 shadow">
                <h5>Logs Today</h5>
                <h2 id="kpi-today">...</h2>
            </div>
        </div>
        <div class="col">
            <div class="card p-3 mb-3 shadow">
                <h5>Error Logs</h5>
                <h2 id="kpi-errors">...</h2>
            </div>
        </div>
        <div class="col">
            <div class="card p-3 mb-3 shadow">
                <h5>Uploads</h5>
                <h2 id="kpi-uploads">...</h2>
            </div>
        </div>
        <div class="col">
            <div class="card p-3 mb-3 shadow">
                <h5>Alerts Today</h5>
                <h2 id="kpi-alerts">...</h2>
            </div>
        </div>
    </div>

    <!-- Chart.js section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow p-3">
                <h5>Failed Logins Over Time</h5>
                <canvas id="loginChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Recent uploads table -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow p-3">
                <h5>Recent Uploaded Files</h5>
                <table class="table" id="uploads-table">
                    <thead>
                        <tr>
                            <th>Filename</th>
                            <th>Type</th>
                            <th>Size (bytes)</th>
                            <th>Date</th>
                        </tr>
                    </thead>
                    <tbody>
                    <!-- Filled by JS -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Kibana dashboard iframe -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card shadow p-3">
                <h5>Kibana Security Dashboard</h5>
                <iframe
                    src="http://localhost:5601/app/dashboards#/view/12415d2a-e26e-4eda-8f3f-2d0051c9fb7a?_g=(refreshInterval:(pause:!t,value:60000),time:(from:'2025-11-01T10:17:16.510Z',to:now))"
                    style="width: 100%; height: 600px; border: none;">
                </iframe>
            </div>
        </div>
    </div>
</div>

<!-- JS for loading data and chart -->
<script>
document.addEventListener('DOMContentLoaded', function() {

    // KPIs
    fetch('/stats').then(r => r.json()).then(function(data) {
        document.getElementById('kpi-total').textContent = data.total_logs;
        document.getElementById('kpi-today').textContent = data.today_logs;
        document.getElementById('kpi-errors').textContent = data.error_logs;
        document.getElementById('kpi-uploads').textContent = data.uploads_count;
        document.getElementById('kpi-alerts').textContent = data.alerts_today;
    });

    // Recent uploads
    fetch('/uploads').then(r => r.json()).then(function(data) {
        let body = "";
        data.uploads.slice(0,5).forEach(u => {
            body += `<tr><td>${u.filename}</td><td>${u.type}</td><td>${u.size}</td><td>${u.upload_date}</td></tr>`;
        });
        document.querySelector("#uploads-table tbody").innerHTML = body;
    });

    // Failed logins chart
    fetch('/search?q=login_failure&size=100')
        .then(r => r.json())
        .then(function(data) {
            let counts = {};
            data.results.forEach(d => {
                if (!d.timestamp) return;
                let date = d.timestamp.slice(0,10); // YYYY-MM-DD
                counts[date] = (counts[date] || 0) + 1;
            });
            let labels = Object.keys(counts).sort();
            let values = labels.map(x => counts[x]);
            new Chart(document.getElementById('loginChart').getContext('2d'), {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Failed Logins',
                        data: values,
                        backgroundColor: '#df4b4b'
                    }]
                }
            });
        });
});
</script>
</body>
</html>
